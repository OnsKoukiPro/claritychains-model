services:
  # Main Streamlit Dashboard
  critical-materials-app:
    build:
      context: .
      dockerfile: ./Dockerfile
    ports:
      - "8501:8501"
    volumes:
      - ./data:/app/data
      - ./config:/app/config
      - ./logs:/app/logs
      - ./cache:/app/cache
      - ./src:/app/src
      - ./:/app
      - ./agent:/app/agent
    environment:
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
      - PYTHONPATH=/app/src
      - DATA_DIR=/app/data
      - CONFIG_DIR=/app/config
      - AGENT_API_URL=http://agent-api:8000
      - DOCKER_ENV=true
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - agent-api

  agent-api:
    build:
      context: .
      dockerfile: ./Dockerfile.agent
    ports:
      - "8000:8000"
    volumes:
      - ./agent:/app
      - ./agent_data/runs:/app/runs
      - ./agent_data/uploaded_files:/app/uploaded_files
      - ./config:/app/config
    environment:
      - PYTHONPATH=/app
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_OPENAI_API_VERSION=${AZURE_OPENAI_API_VERSION:-2024-02-15-preview}
      - AZURE_OPENAI_DEPLOYMENT_NAME=${AZURE_OPENAI_DEPLOYMENT_NAME}
      - AZURE_OPENAI_MODEL_NAME=${AZURE_OPENAI_MODEL_NAME:-gpt-4}
      - USE_RETRIEVER=${USE_RETRIEVER}
      - AZURE_OPENAI_EMBEDDING_DEPLOYMENT=${AZURE_OPENAI_EMBEDDING_DEPLOYMENT}
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Data pipeline service (optional - for scheduled data updates)
  data-pipeline:
    build:
      context: .
      dockerfile: ./Dockerfile.data-pipeline
    volumes:
      - ./data:/app/data
      - ./config:/app/config
    environment:
      - PYTHONPATH=/app/src
    env_file:
      - .env
    command: ["python", "scripts/fetch_all_data.py"]
    restart: "no"

  # Jupyter notebook service for analysis (optional)
  jupyter:
    build:
      context: .
      dockerfile: ./Dockerfile
    ports:
      - "8888:8888"
    volumes:
      - ./notebooks:/app/notebooks
      - ./data:/app/data
      - ./src:/app/src
      - ./agent:/app/agent
    environment:
      - JUPYTER_PORT=8888
    command: ["jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root", "--NotebookApp.token=''"]
    restart: unless-stopped

volumes:
  data_volume:
  logs_volume:
  agent_data_volume: